---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.0
  name: korpscans.korp.io
spec:
  group: korp.io
  names:
    kind: KorpScan
    listKind: KorpScanList
    plural: korpscans
    singular: korpscan
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.targetNamespace
      name: Target
      type: string
    - jsonPath: .spec.intervalMinutes
      name: Interval
      type: integer
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .status.summary.orphanCount
      name: Orphans
      type: integer
    - jsonPath: .status.summary.servicesWithoutEndpoints
      name: Services
      priority: 1
      type: integer
    - jsonPath: .status.summary.orphanedDeployments
      name: Deploys
      priority: 1
      type: integer
    - jsonPath: .status.lastScanTime
      name: LastScan
      type: date
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: KorpScan is the Schema for the korpscans API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: KorpScanSpec defines the desired state of KorpScan
            properties:
              cleanup:
                description: Cleanup configuration for automatic resource cleanup
                properties:
                  dryRun:
                    default: true
                    description: |-
                      DryRun when true, only logs what would be deleted without actually deleting
                      IMPORTANT: Default is true for safety - must explicitly set to false to delete
                    type: boolean
                  enabled:
                    default: false
                    description: Enabled determines if automatic cleanup is enabled
                    type: boolean
                  minAgeDays:
                    default: 7
                    description: |-
                      MinAgeDays is the minimum age in days before a resource is eligible for cleanup
                      Resources must be orphaned for at least this many days before deletion
                    minimum: 0
                    type: integer
                  preservationLabels:
                    description: |-
                      PreservationLabels are label keys that, when present on a resource, prevent cleanup
                      Example: "korp.io/preserve", "do-not-delete"
                    items:
                      type: string
                    type: array
                  resourceTypes:
                    description: |-
                      ResourceTypes specifies which resource types to clean up
                      If empty, all detected orphan types are eligible for cleanup
                    items:
                      type: string
                    type: array
                type: object
              filters:
                description: Filters for excluding resources
                properties:
                  excludeLabels:
                    additionalProperties:
                      type: string
                    description: ExcludeLabels are label selectors to exclude
                    type: object
                  excludeNamePatterns:
                    description: ExcludeNamePatterns are regex patterns to exclude
                      by name
                    items:
                      type: string
                    type: array
                  excludeNamespaces:
                    description: ExcludeNamespaces are namespaces to completely exclude
                      from scanning
                    items:
                      type: string
                    type: array
                type: object
              intervalMinutes:
                default: 60
                description: IntervalMinutes is the scan interval in minutes
                minimum: 1
                type: integer
              reporting:
                description: Reporting configuration
                properties:
                  createEvents:
                    default: true
                    description: CreateEvents determines if Kubernetes events should
                      be created
                    type: boolean
                  eventSeverity:
                    default: Warning
                    description: EventSeverity is the event severity (Normal or Warning)
                    enum:
                    - Normal
                    - Warning
                    type: string
                  historyLimit:
                    default: 5
                    description: HistoryLimit is the number of scan results to retain
                    maximum: 50
                    minimum: 1
                    type: integer
                  webhook:
                    description: Webhook configuration for sending scan results to
                      external systems
                    properties:
                      headers:
                        additionalProperties:
                          type: string
                        description: Headers are custom HTTP headers to include in
                          the webhook request
                        type: object
                      insecureSkipVerify:
                        default: false
                        description: InsecureSkipVerify skips TLS certificate verification
                          (not recommended)
                        type: boolean
                      method:
                        default: POST
                        description: 'Method is the HTTP method to use (default: POST)'
                        enum:
                        - POST
                        - PUT
                        type: string
                      retryPolicy:
                        description: RetryPolicy defines retry behavior for failed
                          webhook calls
                        properties:
                          initialDelaySeconds:
                            default: 1
                            description: 'InitialDelaySeconds is the initial delay
                              before first retry in seconds (default: 1)'
                            maximum: 60
                            minimum: 1
                            type: integer
                          maxRetries:
                            default: 3
                            description: 'MaxRetries is the maximum number of retry
                              attempts (default: 3)'
                            maximum: 10
                            minimum: 0
                            type: integer
                        type: object
                      timeoutSeconds:
                        default: 30
                        description: 'TimeoutSeconds is the request timeout in seconds
                          (default: 30)'
                        maximum: 300
                        minimum: 1
                        type: integer
                      url:
                        description: URL is the webhook endpoint to send notifications
                          to
                        type: string
                    required:
                    - url
                    type: object
                type: object
              resourceTypes:
                description: ResourceTypes to scan. Defaults to all if empty.
                items:
                  type: string
                type: array
              targetNamespace:
                description: TargetNamespace is the namespace to scan. Use "*" for
                  all namespaces.
                type: string
            required:
            - targetNamespace
            type: object
          status:
            description: KorpScanStatus defines the observed state of KorpScan
            properties:
              cleanupStatus:
                description: CleanupStatus tracks cleanup operation status
                properties:
                  deletedResources:
                    description: DeletedResources lists resources that were deleted
                      in the last cleanup
                    items:
                      description: DeletedResource represents a resource that was
                        deleted
                      properties:
                        deletedAt:
                          description: DeletedAt is when the resource was deleted
                          format: date-time
                          type: string
                        name:
                          description: Name is the name of the deleted resource
                          type: string
                        namespace:
                          description: Namespace is the namespace of the deleted resource
                          type: string
                        resourceType:
                          description: ResourceType is the type of resource (ConfigMap,
                            Secret, etc.)
                          type: string
                      required:
                      - deletedAt
                      - name
                      - namespace
                      - resourceType
                      type: object
                    type: array
                  failedDeletions:
                    description: FailedDeletions lists resources that failed to delete
                    items:
                      description: FailedDeletion represents a resource that failed
                        to delete
                      properties:
                        error:
                          description: Error is the error message explaining the failure
                          type: string
                        name:
                          description: Name is the name of the resource
                          type: string
                        namespace:
                          description: Namespace is the namespace of the resource
                          type: string
                        resourceType:
                          description: ResourceType is the type of resource
                          type: string
                      required:
                      - error
                      - name
                      - namespace
                      - resourceType
                      type: object
                    type: array
                  lastCleanupResult:
                    description: LastCleanupResult indicates the result of the last
                      cleanup (Success, Failed, DryRun)
                    type: string
                  lastCleanupTime:
                    description: LastCleanupTime is when the last cleanup operation
                      completed
                    format: date-time
                    type: string
                  summary:
                    description: Summary of the last cleanup operation
                    properties:
                      dryRun:
                        description: DryRun indicates if this was a dry-run operation
                        type: boolean
                      totalDeleted:
                        description: TotalDeleted is the number of resources actually
                          deleted
                        type: integer
                      totalEligible:
                        description: TotalEligible is the number of resources eligible
                          for cleanup
                        type: integer
                      totalFailed:
                        description: TotalFailed is the number of failed deletion
                          attempts
                        type: integer
                      totalSkippedAge:
                        description: TotalSkippedAge is the count skipped due to age
                          threshold
                        type: integer
                      totalSkippedPreserved:
                        description: TotalSkippedPreserved is the count skipped due
                          to preservation labels
                        type: integer
                    required:
                    - dryRun
                    - totalDeleted
                    - totalEligible
                    - totalFailed
                    - totalSkippedAge
                    - totalSkippedPreserved
                    type: object
                type: object
              conditions:
                description: Conditions represent the latest observations
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              findings:
                description: Findings contains detailed orphan resource information
                items:
                  description: Finding represents a single orphaned resource
                  properties:
                    '---':
                      description: Separator is a visual divider between findings
                      type: string
                    description:
                      description: 'Description is a one-line summary: "ConfigMap
                        korp/name (Reason)"'
                      type: string
                    detectedAt:
                      description: DetectedAt timestamp when this orphan was first
                        detected
                      format: date-time
                      type: string
                    name:
                      description: Name is the name of the orphaned resource
                      type: string
                    namespace:
                      description: Namespace where the resource is located
                      type: string
                    reason:
                      description: Reason explains why this resource is considered
                        orphaned
                      type: string
                    resourceType:
                      description: ResourceType is the kind of resource (ConfigMap,
                        Secret, Service, etc.)
                      type: string
                  required:
                  - detectedAt
                  - name
                  - namespace
                  - reason
                  - resourceType
                  type: object
                type: array
              history:
                description: History of recent scans
                items:
                  description: HistoryEntry represents a historical scan result
                  properties:
                    duration:
                      description: Duration is how long the scan took
                      type: string
                    orphanCount:
                      description: OrphanCount is the number of orphans found
                      type: integer
                    scanTime:
                      description: ScanTime is when the scan completed
                      format: date-time
                      type: string
                  required:
                  - duration
                  - orphanCount
                  - scanTime
                  type: object
                type: array
              lastScanTime:
                description: LastScanTime is when the last scan completed
                format: date-time
                type: string
              phase:
                description: Phase represents the current state
                enum:
                - Pending
                - Running
                - Completed
                - Failed
                type: string
              summary:
                description: Summary of findings
                properties:
                  orphanCount:
                    description: OrphanCount is the total number of orphaned resources
                      found
                    type: integer
                  orphanedClusterRoleBindings:
                    description: OrphanedClusterRoleBindings is the count of orphaned
                      ClusterRoleBindings
                    type: integer
                  orphanedClusterRoles:
                    description: OrphanedClusterRoles is the count of orphaned ClusterRoles
                      (not referenced by any binding)
                    type: integer
                  orphanedConfigMaps:
                    description: OrphanedConfigMaps is the count of orphaned ConfigMaps
                    type: integer
                  orphanedCronJobs:
                    description: OrphanedCronJobs is the count of orphaned CronJobs
                    type: integer
                  orphanedDaemonSets:
                    description: OrphanedDaemonSets is the count of orphaned DaemonSets
                    type: integer
                  orphanedDeployments:
                    description: OrphanedDeployments is the count of orphaned Deployments
                    type: integer
                  orphanedEndpoints:
                    description: OrphanedEndpoints is the count of orphaned Endpoints
                      (no corresponding Service)
                    type: integer
                  orphanedHPAs:
                    description: OrphanedHPAs is the count of orphaned HorizontalPodAutoscalers
                      (targeting non-existent workloads)
                    type: integer
                  orphanedIngresses:
                    description: OrphanedIngresses is the count of orphaned Ingresses
                    type: integer
                  orphanedJobs:
                    description: OrphanedJobs is the count of orphaned Jobs
                    type: integer
                  orphanedNetworkPolicies:
                    description: OrphanedNetworkPolicies is the count of orphaned
                      NetworkPolicies (selector matches no pods)
                    type: integer
                  orphanedPVCs:
                    description: OrphanedPVCs is the count of orphaned PersistentVolumeClaims
                    type: integer
                  orphanedPVs:
                    description: OrphanedPVs is the count of orphaned PersistentVolumes
                      (Released or Available state)
                    type: integer
                  orphanedPodDisruptionBudgets:
                    description: OrphanedPodDisruptionBudgets is the count of orphaned
                      PodDisruptionBudgets (selector matches no pods)
                    type: integer
                  orphanedReplicaSets:
                    description: OrphanedReplicaSets is the count of orphaned ReplicaSets
                    type: integer
                  orphanedRoleBindings:
                    description: OrphanedRoleBindings is the count of orphaned RoleBindings
                      (referencing non-existent roles/subjects)
                    type: integer
                  orphanedRoles:
                    description: OrphanedRoles is the count of orphaned Roles (not
                      referenced by any RoleBinding)
                    type: integer
                  orphanedSecrets:
                    description: OrphanedSecrets is the count of orphaned Secrets
                    type: integer
                  orphanedServiceAccounts:
                    description: OrphanedServiceAccounts is the count of orphaned
                      ServiceAccounts
                    type: integer
                  orphanedStatefulSets:
                    description: OrphanedStatefulSets is the count of orphaned StatefulSets
                    type: integer
                  servicesWithoutEndpoints:
                    description: ServicesWithoutEndpoints is the count of Services
                      without Endpoints
                    type: integer
                  totalResources:
                    description: TotalResources is the total number of resources scanned
                    type: integer
                required:
                - orphanedConfigMaps
                - orphanedPVCs
                - orphanedSecrets
                - servicesWithoutEndpoints
                - totalResources
                type: object
              webhookStatus:
                description: WebhookStatus tracks webhook notification status
                properties:
                  failureCount:
                    description: FailureCount is the number of consecutive webhook
                      failures
                    type: integer
                  lastError:
                    description: LastError contains the error message from the last
                      failed webhook
                    type: string
                  lastFailure:
                    description: LastFailure is the timestamp of the last failed webhook
                      delivery
                    format: date-time
                    type: string
                  lastSuccess:
                    description: LastSuccess is the timestamp of the last successful
                      webhook delivery
                    format: date-time
                    type: string
                type: object
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
